<?php
error_reporting(0);

//require 'Converter.php'; 
//use Pdu\Converter;

$cmd = 'echo -e "AT+CUSD=1,\"AA180C3602\"\r\n">/dev/ttyUSB0|head -n6 /dev/ttyUSB0';// AA180C3602 --> *100# в PDU формате

function geter($cmd){
ob_start();
system($cmd);
sleep(1);
$output = ob_get_contents();
ob_end_clean();
return $output;
}

//echo geter($cmd);

$data = geter($cmd);

if (preg_match_all("/\+CUSD\:\s\d\,\"(.){1,}\"\,/i",$data, $pdu)) {
    $fin = preg_replace("/\+CUSD\:\s\d\,\"/","",$pdu[0][0]);

$code = str_replace('",','',$fin);

} else {
$code = "fuck... =( error\r\n";
}


//$code = "0414043E044104420443043F043D043E003A0020003200390039002E0030003000200440002E000A0412043004480438002004410440043504340441044204320430003A0020003200390038002E0039003900200440002E000A041B0438043C04380442003A00200030002E0030003100200440002E";

$pattern = ["0020","0021","0022","0023","0024","0025","0026","0027","0028","0029","002A","002B","002C","002D","002E","002F",
    "0030","0031","0032","0033","0034","0035","0036","0037","0038","0039","003A","003B","003C","003D","003E","003F",
    "0040","0041","0042","0043","0044","0045","0046","0047","0048","0049","004A","004B","004C","004D","004E","004F",
    "0050","0051","0052","0053","0054","0055","0056","0057","0058","0059","005A","005B","005C","005D","005E","005F",
    "0060","0061","0062","0063","0064","0065","0066","0067","0068","0069","0006A","006B","006C","006D","006E","006F",
    "0070","0071","0072","0073","0074","0075","0076","0077","0078","0079","007A","007B","007C","007D","007E",
    "00A0","0401","0402","0403","0404","0405","0406","0407","0408","0409","040A","040B","040C","040D","040E","040F",
    "0410","0411","0412","0413","0414","0415","0416","0417","0418","0419","041A","041B","041C","041D","041E","041F",
    "0420","0421","0422","0423","0424","0425","0426","0427","0428","0429","042A","042B","042C","042D","042E","042F",
    "0430","0431","0432","0433","0434","0435","0436","0437","0438","0439","043A","043B","043C","043D","043E","043F",
    "0440","0441","0442","0443","0444","0445","0446","0447","0448","0449","044A","044B","044C","044D","044E","044F",
    "2116","0451","0452","0453","0454","0455","0456","0457","0458","0459","045A","045B","045C","00A7","045E","045F","000A"];

$out = [" ","!","\"","#","$","%","&","'","(",")","*","+",",",
    "-",".","/","0","1","2","3","4","5","6","7","8","9",":",
";","<","=",">","?","@","A","B","C","D","E","F","G","H","I",
"J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X",
"Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g",
"h","i","j","k","l","m","n","o","p","q","r","s","t","u","v",
"w","x","y","z","{","|","}","~","<br/>","Ё","Ђ","Ѓ","Є","Ѕ",
"І","Ї","Ј","Љ","Њ","Ћ","Ќ","SHY","Ў","Џ","А","Б","В","Г",
"Д","Е","Ж","З","И","Й","К","Л","М","Н","О","П","Р","С","Т",
"У","Ф","Х","Ц","Ч","Ш","Щ","Ъ","Ы","Ь","Э","Ю","Я","а","б",
"в","г","д","е","ж","з","и","й","к","л","м","н","о","п","р",
"с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я",
"№","ё","ђ","ѓ","є","ѕ","і","ї","ј","љ","њ","ћ","ќ","§","ў","џ","\r\n"];

$s = 0;
$ara = array();
for($i=0;$i<(strlen($code)/4);$i++){
$ara[].= substr($code,$s,4);
$s = $s+4;
echo str_replace($pattern,$out,$ara[$i]);
}


//echo count($pattern)."<br/>".count($out);
//echo $pattern[174]."=".$out[174];

//var_dump(Converter::toText($code));
//var_dump(Converter::toPdu("*100#"));//Megafon balance *100# ; beeline *102#
;?>
